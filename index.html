<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>JDM Arcade: Final Fix</title>
    <style>
        :root { 
            --bg: #050505; --neon-blue: #00d2ff; --neon-red: #ff0055; 
            --neon-green: #00ff88; --gold: #ffcc00; --track: #1a1a1b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg); color: white; font-family: 'Courier New', monospace; 
            margin: 0; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; min-height: 100vh; overflow: hidden; 
        }

        /* --- UI LAYERS --- */
        .header { width: 320px; display: flex; justify-content: space-between; align-items: center; padding: 10px; z-index: 100; }
        #balance { font-size: 2rem; font-weight: bold; color: var(--neon-blue); }
        
        #game-container {
            position: relative; width: 320px; height: 420px;
            background: var(--track); border: 12px solid #222; border-radius: 40px;
            display: flex; align-items: center; justify-content: center;
        }

        #racers-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        .pit { display: grid; grid-template-columns: repeat(3, 70px); gap: 10px; z-index: 10; position: relative; }
        .slot { 
            width: 70px; height: 70px; background: rgba(0,0,0,0.6); 
            border: 1px solid #333; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
        }

        .racer { position: absolute; width: 26px; height: 12px; background: var(--c); border-radius: 2px; will-change: transform; }

        /* --- BUTTONS --- */
        .controls { margin-top: 15px; display: flex; flex-direction: column; gap: 8px; width: 300px; z-index: 100; }
        .btn { padding: 12px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        #buy-btn { background: var(--neon-red); color: white; }
        .secondary-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .wheel-btn { background: var(--gold); color: black; }
        .turbo-btn { background: var(--neon-green); color: black; }

        /* --- POPUPS & PANELS --- */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 1000; display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
        }
        
        #settings-panel {
            position: fixed; top: 0; right: -280px; width: 260px; height: 100%;
            background: #111; border-left: 2px solid var(--neon-blue);
            z-index: 2000; transition: 0.3s; padding: 20px;
        }
        #settings-panel.open { right: 0; }

        /* --- LUCKY WHEEL UI --- */
        #wheel-container {
            width: 260px; height: 260px; border: 5px solid var(--gold);
            border-radius: 50%; position: relative; transition: transform 4s cubic-bezier(0.1, 0, 0.2, 1);
            background: conic-gradient(var(--neon-red) 0deg 90deg, var(--neon-blue) 90deg 180deg, var(--neon-green) 180deg 270deg, var(--gold) 270deg 360deg);
        }
    </style>
</head>
<body>

    <div class="header">
        <div id="balance">$100</div>
        <button onclick="game.openSettings()" style="background:none; border:none; color:white; font-size:1.5rem;">‚öôÔ∏è</button>
    </div>

    <div id="game-container">
        <div id="racers-layer"></div>
        <div class="pit" id="pit-grid"></div>
    </div>

    <div class="controls">
        <button id="buy-btn" class="btn" onclick="game.buyCar()">Buy Car ($75)</button>
        <div class="secondary-btns">
            <button class="btn wheel-btn" onclick="game.openWheel()">üé° SPIN</button>
            <button class="btn turbo-btn" onclick="game.triggerTurboAd()">üöÄ TURBO</button>
        </div>
    </div>

    <div id="wheel-overlay" class="overlay">
        <h2 style="color:var(--gold)">LUCKY WHEEL</h2>
        <div id="wheel-container"></div>
        <button id="spin-start-btn" class="btn" style="margin-top:20px; width:200px; background:white;" onclick="game.spinWheel()">SPIN FOR $50</button>
        <button onclick="game.closeWheel()" style="margin-top:10px; color:gray; background:none; border:none;">Close</button>
    </div>

    <div id="settings-panel">
        <button onclick="game.closeSettings()" style="background:none; border:none; color:white; float:right;">X</button>
        <h2 style="color:var(--neon-blue);">SETTINGS</h2>
        <p>Stats:</p>
        <small id="stat-earned">Lifetime: $0</small>
        <hr style="border:0; border-top:1px solid #333; margin:20px 0;">
        <button class="btn" style="background:#400; color:white; width:100%;" onclick="game.resetGame()">RESET PROGRESS</button>
    </div>

    <script>
        const CAR_STATS = [
            { n: "Civic", c: "#ffffff", i: 2, spd: 1.8 },
            { n: "GTI", c: "#ff4444", i: 5, spd: 2.1 },
            { n: "RX-7", c: "#f1c40f", i: 2.4, i: 12 },
            { n: "M3", c: "#3498db", i: 2.7, i: 30 }
        ];

        class JDM_Final {
            constructor() {
                const s = JSON.parse(localStorage.getItem('jdm_final_save')) || {};
                this.coins = s.coins || 100;
                this.grid = s.grid || Array(9).fill(null);
                this.buyCount = s.buyCount || 0;
                this.totalEarned = s.totalEarned || 100;
                this.turboMult = 1;
                this.activeRacers = [];
                this.init();
            }

            init() {
                this.renderGrid();
                this.syncRacers();
                requestAnimationFrame(() => this.loop());
            }

            // --- UI ACTIONS ---
            openSettings() { document.getElementById('settings-panel').classList.add('open'); }
            closeSettings() { document.getElementById('settings-panel').classList.remove('open'); }
            openWheel() { document.getElementById('wheel-overlay').style.display = 'flex'; }
            closeWheel() { document.getElementById('wheel-overlay').style.display = 'none'; }
            
            resetGame() {
                if(confirm("Wipe everything?")) {
                    localStorage.removeItem('jdm_final_save');
                    location.reload();
                }
            }

            buyCar() {
                const cost = Math.floor(75 * Math.pow(1.3, this.buyCount));
                if (this.coins >= cost && this.grid.includes(null)) {
                    this.coins -= cost;
                    this.grid[this.grid.indexOf(null)] = 0;
                    this.buyCount++;
                    this.updateAll();
                }
            }

            merge(idx) {
                const lvl = this.grid[idx];
                if (lvl === null || lvl >= 7) return;
                const match = this.grid.findIndex((l, i) => l === lvl && i !== idx);
                if (match !== -1) {
                    this.grid[idx] = lvl + 1;
                    this.grid[match] = null;
                    this.updateAll();
                }
            }

            updateAll() {
                this.renderGrid();
                this.syncRacers();
                this.save();
            }

            save() {
                localStorage.setItem('jdm_final_save', JSON.stringify({
                    coins: this.coins, grid: this.grid, buyCount: this.buyCount, totalEarned: this.totalEarned
                }));
            }

            // --- RACING ENGINE ---
            syncRacers() {
                const layer = document.getElementById('racers-layer');
                layer.innerHTML = '';
                this.activeRacers = [];
                this.grid.forEach(lvl => {
                    if (lvl !== null) {
                        const r = { lvl, prog: Math.random() * 1000, el: document.createElement('div') };
                        r.el.className = 'racer';
                        r.el.style.setProperty('--c', CAR_STATS[lvl]?.c || '#fff');
                        layer.appendChild(r.el);
                        this.activeRacers.push(r);
                    }
                });
            }

            loop() {
                const W = 285, H = 385; // Fixed path bounds
                const lap = (W * 2) + (H * 2);

                this.activeRacers.forEach(r => {
                    r.prog += (CAR_STATS[r.lvl]?.spd || 1) * this.turboMult;
                    let p = r.prog % lap;
                    let x, y, ang;

                    if (p < W) { x = p; y = 0; ang = 0; }
                    else if (p < W + H) { x = W; y = p - W; ang = 90; }
                    else if (p < (W * 2) + H) { x = W - (p - (W + H)); y = H; ang = 180; }
                    else { x = 0; y = H - (p - (W * 2 + H)); ang = 270; }

                    r.el.style.transform = `translate(${x + 5}px, ${y + 5}px) rotate(${ang}deg)`;
                    if (Math.random() < 0.01) this.coins += (CAR_STATS[r.lvl]?.i || 1) / 50 * this.turboMult;
                });

                document.getElementById('balance').innerText = `$${Math.floor(this.coins)}`;
                document.getElementById('stat-earned').innerText = `Lifetime: $${Math.floor(this.totalEarned)}`;
                requestAnimationFrame(() => this.loop());
            }

            renderGrid() {
                const pit = document.getElementById('pit-grid');
                pit.innerHTML = '';
                this.grid.forEach((lvl, i) => {
                    const slot = document.createElement('div');
                    slot.className = 'slot';
                    if (lvl !== null) slot.innerHTML = `<div class="racer" style="position:relative; --c:${CAR_STATS[lvl].c}"></div>`;
                    slot.onclick = () => this.merge(i);
                    pit.appendChild(slot);
                });
            }

            // --- WHEEL LOGIC ---
            spinWheel() {
                if (this.coins < 50) return alert("Need $50!");
                this.coins -= 50;
                const wheel = document.getElementById('wheel-container');
                const randDeg = 1800 + Math.floor(Math.random() * 360);
                wheel.style.transform = `rotate(${randDeg}deg)`;
                
                setTimeout(() => {
                    const win = Math.floor(Math.random() * 3);
                    if (win === 0) { this.coins += 500; alert("WON $500!"); }
                    else if (win === 1) { this.startTurbo(30); alert("30s TURBO!"); }
                    else { alert("Better luck next time!"); }
                    this.save();
                }, 4100);
            }

            startTurbo(sec) {
                this.turboMult = 3;
                setTimeout(() => { this.turboMult = 1; }, sec * 1000);
            }
        }

        const game = new JDM_Final();
    </script>
</body>
</html>
