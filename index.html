<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Fuse Highway</title>
    <style>
        :root { 
            --bg: #050505; --neon-blue: #00d2ff; --neon-red: #ff0055; 
            --neon-green: #00ff88; --gold: #ffcc00; --track: #1a1a1b;
        }
        body { 
            background: var(--bg); color: white; font-family: 'Courier New', monospace; 
            margin: 0; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; height: 100vh; overflow: hidden; 
        }
        
        /* Turbo Mode Visuals */
        body.turbo-active { animation: glitch 0.1s infinite; }
        body.turbo-active #game-board { border-color: var(--neon-green); box-shadow: 0 0 40px var(--neon-green); }
        @keyframes glitch { 0% { transform: translate(1px,0); } 50% { transform: translate(-1px,1px); } 100% { transform: translate(0,-1px); } }

        /* HUD & Settings */
        .header { width: 340px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        #balance { font-size: 2.2rem; font-weight: bold; color: var(--neon-blue); text-shadow: 0 0 10px var(--neon-blue); }
        .settings-btn { font-size: 1.5rem; cursor: pointer; background: none; border: none; color: white; }

        #game-board {
            position: relative; width: 340px; height: 460px;
            background: var(--track); border: 12px solid #222; border-radius: 45px;
            display: flex; align-items: center; justify-content: center;
        }

        .pit { display: grid; grid-template-columns: repeat(3, 80px); gap: 10px; z-index: 10; }
        .slot { width: 80px; height: 80px; background: rgba(0,0,0,0.5); border: 1px solid #333; border-radius: 12px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .racer { position: absolute; width: 30px; height: 14px; background: var(--c); border-radius: 2px; z-index: 5; }
        .racer::after { content: ''; position: absolute; top: -4px; left: 8px; width: 10px; height: 6px; background: #000; border: 1px solid var(--c); }
        
        .controls { margin-top: 15px; display: flex; flex-direction: column; gap: 8px; width: 320px; }
        .btn { padding: 14px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        #buy-btn { background: var(--neon-red); color: white; }
        #ad-btn { background: #222; color: var(--gold); border: 1px solid var(--gold); }

        /* --- SETTINGS PANEL --- */
        #settings-panel {
            position: fixed; top: 0; right: -300px; width: 250px; height: 100%;
            background: #111; border-left: 2px solid var(--neon-blue);
            z-index: 300; transition: 0.3s; padding: 20px;
        }
        #settings-panel.open { right: 0; }
        .setting-item { margin: 20px 0; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .reset-btn { background: #440000; color: #ff4444; border: 1px solid #ff4444; padding: 10px; width: 100%; cursor: pointer; font-weight: bold; }

        /* Overlays */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 400; display: none; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>

    <div class="header">
        <div id="balance">$100</div>
        <button class="settings-btn" onclick="game.toggleSettings()">‚öôÔ∏è</button>
    </div>
    <div id="turbo-timer" style="color:var(--neon-green); font-size: 0.8rem; margin-bottom: 5px; height: 15px;"></div>

    <div id="game-board">
        <div id="racers-layer"></div>
        <div class="pit" id="pit-grid"></div>
    </div>

    <div class="controls">
        <button id="buy-btn" class="btn" onclick="game.buyCar()">Buy Car ($75)</button>
        <button id="ad-btn" class="btn" onclick="game.triggerTurboAd()">üì∫ Watch Ad (3X Turbo)</button>
    </div>

    <div id="settings-panel">
        <button onclick="game.toggleSettings()" style="background:none; border:none; color:white; float:right;">X</button>
        <h2 style="color:var(--neon-blue);">SETTINGS</h2>
        <div class="setting-item">
            <p>STATS</p>
            <small id="stat-total">Total Earned: $0</small><br>
            <small id="stat-buys">Cars Bought: 0</small>
        </div>
        <div class="setting-item">
            <p>AUTOSAVE</p>
            <small style="color:var(--neon-green);">‚óè Status: Online</small>
        </div>
        <div class="setting-item">
            <button class="reset-btn" onclick="game.resetGame()">WIPE DATA (RESET)</button>
        </div>
    </div>

    <div id="ad-overlay" class="overlay">
        <div style="border: 2px solid var(--gold); padding: 25px; border-radius: 20px; text-align: center; background: #111; width: 260px;">
            <h2 style="color:var(--gold);">TURBO SPONSOR</h2>
            <p>3X Speed & Earnings!</p>
            <p id="ad-timer">15s remaining...</p>
            <button onclick="game.reqSkip()" style="color: #444; background: none; border: none; cursor:pointer;">Skip</button>
        </div>
    </div>

    <div id="warn-modal" class="overlay" style="z-index: 500;">
        <div style="background:#1a1a1a; border:2px solid var(--neon-red); padding:30px; border-radius:20px; text-align:center; width:250px;">
            <h3 style="color:var(--neon-red);">STOP?</h3>
            <p>You'll lose the boost!</p>
            <button class="btn" style="background:var(--neon-green); width:100%;" onclick="game.resumeAd()">KEEP WATCHING</button>
            <button class="btn" style="background:none; color:#ff4444; margin-top:10px;" onclick="game.abortAd()">CANCEL</button>
        </div>
    </div>

    <script>
        const CAR_STATS = [
            { n: "Civic", c: "#ffffff", i: 2, spd: 1.5 },
            { n: "GTI", c: "#ff4444", i: 5, spd: 1.8 },
            { n: "RX-7", c: "#f1c40f", i: 12, spd: 2.1 },
            { n: "M3", c: "#3498db", i: 30, spd: 2.4 },
            { n: "Supra", c: "#e67e22", i: 75, spd: 2.7 },
            { n: "911", c: "#95a5a6", i: 180, spd: 3.0 },
            { n: "GT-R", c: "#2c3e50", i: 450, spd: 3.3 },
            { n: "R8", c: "#111111", i: 1200, spd: 3.6 }
        ];

        class Pro_JDM_Arcade {
            constructor() {
                const s = JSON.parse(localStorage.getItem('jdm_pro_save')) || {};
                this.coins = s.coins || 100;
                this.grid = s.grid || Array(9).fill(null);
                this.buyCount = s.buyCount || 0;
                this.totalEarned = s.totalEarned || 100;

                this.isTurbo = false;
                this.turboMult = 1;
                this.activeRacers = [];
                this.init();
            }

            init() {
                this.syncRacers();
                this.renderGrid();
                requestAnimationFrame(() => this.loop());
            }

            save() {
                localStorage.setItem('jdm_pro_save', JSON.stringify({
                    coins: this.coins, grid: this.grid, buyCount: this.buyCount, totalEarned: this.totalEarned
                }));
            }

            resetGame() {
                if(confirm("Wipe all cars and coins?")) {
                    localStorage.removeItem('jdm_pro_save');
                    location.reload();
                }
            }

            toggleSettings() { document.getElementById('settings-panel').classList.toggle('open'); }

            buyCar() {
                const cost = Math.floor(75 * Math.pow(1.3, this.buyCount));
                const empty = this.grid.indexOf(null);
                if (this.coins >= cost && empty !== -1) {
                    this.coins -= cost;
                    this.grid[empty] = 0;
                    this.buyCount++;
                    this.syncRacers();
                    this.renderGrid();
                    this.save();
                }
            }

            merge(idx) {
                const lvl = this.grid[idx];
                if (lvl === null || lvl >= 7) return;
                const match = this.grid.findIndex((l, i) => l === lvl && i !== idx);
                if (match !== -1) {
                    this.grid[idx] = lvl + 1;
                    this.grid[match] = null;
                    this.syncRacers();
                    this.renderGrid();
                    this.save();
                }
            }

            syncRacers() {
                const layer = document.getElementById('racers-layer');
                layer.innerHTML = '';
                this.activeRacers = [];
                this.grid.forEach(lvl => {
                    if (lvl !== null) {
                        const r = { lvl, prog: Math.random() * 1000, el: document.createElement('div') };
                        r.el.className = 'racer';
                        r.el.style.setProperty('--c', CAR_STATS[lvl].c);
                        layer.appendChild(r.el);
                        this.activeRacers.push(r);
                    }
                });
            }

            loop() {
                const W = 300, H = 420;
                this.activeRacers.forEach(r => {
                    r.prog += CAR_STATS[r.lvl].spd * this.turboMult;
                    let p = r.prog % (W*2 + H*2);
                    let x, y, ang;
                    if (p < W) { x = p; y = 0; ang = 0; }
                    else if (p < W+H) { x = W; y = p-W; ang = 90; }
                    else if (p < W*2+H) { x = W-(p-(W+H)); y = H; ang = 180; }
                    else { x = 0; y = H-(p-(W*2+H)); ang = 270; }

                    r.el.style.left = (x + 20) + 'px';
                    r.el.style.top = (y + 20) + 'px';
                    r.el.style.transform = `rotate(${ang}deg)`;
                    
                    if (Math.random() < 0.02) {
                        const inc = (CAR_STATS[r.lvl].i / 50) * this.turboMult;
                        this.coins += inc;
                        this.totalEarned += inc;
                    }
                });

                document.getElementById('balance').innerText = `$${Math.floor(this.coins)}`;
                document.getElementById('stat-total').innerText = `Total Earned: $${Math.floor(this.totalEarned)}`;
                document.getElementById('stat-buys').innerText = `Cars Bought: ${this.buyCount}`;
                this.updateUI();
                requestAnimationFrame(() => this.loop());
            }

            renderGrid() {
                const pit = document.getElementById('pit-grid');
                pit.innerHTML = '';
                this.grid.forEach((lvl, i) => {
                    const slot = document.createElement('div');
                    slot.className = 'slot';
                    if (lvl !== null) slot.innerHTML = `<div class="racer" style="position:static; --c:${CAR_STATS[lvl].c}"></div>`;
                    slot.onclick = () => this.merge(i);
                    pit.appendChild(slot);
                });
            }

            updateUI() {
                const cost = Math.floor(75 * Math.pow(1.3, this.buyCount));
                const btn = document.getElementById('buy-btn');
                btn.innerText = `Buy Car ($${cost})`;
                btn.disabled = (this.coins < cost || !this.grid.includes(null));
            }

            /* Turbo Ad Logic */
            triggerTurboAd() {
                this.adPaused = false; let time = 15;
                document.getElementById('ad-overlay').style.display = 'flex';
                this.adInterval = setInterval(() => {
                    if (!this.adPaused) {
                        time--;
                        document.getElementById('ad-timer').innerText = `${time}s remaining...`;
                        if (time <= 0) { clearInterval(this.adInterval); this.startTurbo(); }
                    }
                }, 1000);
            }
            startTurbo() {
                document.getElementById('ad-overlay').style.display = 'none';
                this.isTurbo = true; this.turboMult = 3;
                let timeLeft = 300;
                document.body.classList.add('turbo-active');
                const t = setInterval(() => {
                    timeLeft--;
                    let m = Math.floor(timeLeft/60).toString().padStart(2,'0');
                    let s = (timeLeft%60).toString().padStart(2,'0');
                    document.getElementById('turbo-timer').innerText = `TURBO ACTIVE: ${m}:${s}`;
                    if(timeLeft <= 0) {
                        clearInterval(t); this.isTurbo = false; this.turboMult = 1;
                        document.body.classList.remove('turbo-active');
                        document.getElementById('turbo-timer').innerText = '';
                    }
                }, 1000);
            }
            reqSkip() { this.adPaused = true; document.getElementById('warn-modal').style.display = 'flex'; }
            resumeAd() { this.adPaused = false; document.getElementById('warn-modal').style.display = 'none'; }
            abortAd() { clearInterval(this.adInterval); document.getElementById('ad-overlay').style.display = 'none'; document.getElementById('warn-modal').style.display = 'none'; }
        }

        const game = new Pro_JDM_Arcade();
    </script>
</body>
</html>
