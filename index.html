<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fuse Highway</title>
    <style>
        :root { 
            --bg: #050505; --neon-blue: #00d2ff; --neon-red: #ff0055; 
            --neon-green: #00ff88; --gold: #ffcc00; --track: #1a1a1b;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg); color: white; font-family: 'Courier New', monospace; 
            margin: 0; display: flex; flex-direction: column; align-items: center; 
            justify-content: center; min-height: 100vh; overflow: hidden; 
        }

        /* UI LAYERS - Ensure buttons are always on top */
        .header { width: 320px; display: flex; justify-content: space-between; align-items: center; padding: 10px; z-index: 500; }
        #balance { font-size: 2.2rem; font-weight: bold; color: var(--neon-blue); }
        
        #game-container {
            position: relative; width: 320px; height: 420px;
            background: var(--track); border: 12px solid #222; border-radius: 40px;
            display: flex; align-items: center; justify-content: center;
        }

        /* Racers stay in the background */
        #racers-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }

        .pit { display: grid; grid-template-columns: repeat(3, 70px); gap: 10px; z-index: 100; position: relative; }
        .slot { 
            width: 70px; height: 70px; background: rgba(0,0,0,0.6); 
            border: 1px solid #333; border-radius: 12px; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; 
        }

        .racer { position: absolute; width: 26px; height: 12px; background: var(--c); border-radius: 2px; will-change: transform; }

        .controls { margin-top: 15px; display: flex; flex-direction: column; gap: 8px; width: 300px; z-index: 500; }
        .btn { padding: 14px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        #buy-btn { background: var(--neon-red); color: white; }
        
        .secondary-btns { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .wheel-btn { background: var(--gold); color: black; }
        .turbo-btn { background: var(--neon-green); color: black; }

        /* Full Screen Overlays */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.98); z-index: 1000; display: none; 
            flex-direction: column; align-items: center; justify-content: center; 
        }
    </style>
</head>
<body>

    <div class="header">
        <div id="balance">$100</div>
        <button onclick="game.openSettings()" style="background:none; border:none; color:white; font-size:1.8rem; cursor:pointer;">‚öôÔ∏è</button>
    </div>

    <div id="game-container">
        <div id="racers-layer"></div>
        <div class="pit" id="pit-grid"></div>
    </div>

    <div class="controls">
        <button id="buy-btn" class="btn" onclick="game.buyCar()">Buy Car ($75)</button>
        <div class="secondary-btns">
            <button class="btn wheel-btn" onclick="game.openWheel()">üé° SPIN</button>
            <button class="btn turbo-btn" onclick="game.triggerTurboAd()">üöÄ TURBO</button>
        </div>
    </div>

    <div id="ad-overlay" class="overlay">
        <div style="border:2px solid var(--gold); padding:30px; border-radius:20px; text-align:center; background:#111; width:280px;">
            <h2 style="color:var(--gold)">AD SPONSOR</h2>
            <p>Watching for 3X Turbo...</p>
            <h1 id="ad-timer">5s</h1>
        </div>
    </div>

    <script>
        // CAR SPEED BOOSTED
        const CAR_STATS = [
            { n: "Civic", c: "#ffffff", spd: 4.5 }, 
            { n: "GTI", c: "#ff4444", spd: 5.5 },   
            { n: "RX-7", c: "#f1c40f", spd: 6.5 },  
            { n: "M3", c: "#3498db", spd: 7.5 }    
        ];

        class JDM_Turbo_Final_Fix {
            constructor() {
                const s = JSON.parse(localStorage.getItem('jdm_save_v5')) || {};
                this.coins = s.coins ?? 100;
                this.grid = s.grid || Array(9).fill(null);
                this.buyCount = s.buyCount || 0;
                this.turboMult = 1;
                this.activeRacers = [];
                
                this.init();
                setInterval(() => this.tickIncome(), 1000);
            }

            init() {
                this.renderGrid();
                this.syncRacers();
                requestAnimationFrame(() => this.loop());
            }

            tickIncome() {
                let carCount = this.grid.filter(x => x !== null).length;
                if (carCount > 0) {
                    this.coins += carCount * this.turboMult;
                    this.save();
                }
            }

            // --- TURBO LOGIC ---
            triggerTurboAd() {
                const adEl = document.getElementById('ad-overlay');
                const timerEl = document.getElementById('ad-timer');
                adEl.style.display = 'flex';
                
                let count = 5;
                timerEl.innerText = count + "s";
                
                const int = setInterval(() => {
                    count--;
                    timerEl.innerText = count + "s";
                    if(count <= 0) {
                        clearInterval(int);
                        adEl.style.display = 'none';
                        this.activateTurbo();
                    }
                }, 1000);
            }

            activateTurbo() {
                this.turboMult = 3;
                document.getElementById('game-container').style.borderColor = "var(--neon-green)";
                setTimeout(() => {
                    this.turboMult = 1;
                    document.getElementById('game-container').style.borderColor = "#222";
                }, 300000); // 5 Minutes
            }

            // --- CORE ENGINE ---
            buyCar() {
                const cost = Math.floor(75 * Math.pow(1.3, this.buyCount));
                if (this.coins >= cost && this.grid.includes(null)) {
                    this.coins -= cost;
                    this.grid[this.grid.indexOf(null)] = 0;
                    this.buyCount++;
                    this.updateAll();
                }
            }

            merge(idx) {
                const lvl = this.grid[idx];
                if (lvl === null || lvl >= 3) return;
                const match = this.grid.findIndex((l, i) => l === lvl && i !== idx);
                if (match !== -1) {
                    this.grid[idx] = lvl + 1;
                    this.grid[match] = null;
                    this.updateAll();
                }
            }

            updateAll() { this.renderGrid(); this.syncRacers(); this.save(); }
            save() { localStorage.setItem('jdm_save_v5', JSON.stringify({ coins: this.coins, grid: this.grid, buyCount: this.buyCount })); }

            syncRacers() {
                const layer = document.getElementById('racers-layer');
                layer.innerHTML = '';
                this.activeRacers = [];
                this.grid.forEach(lvl => {
                    if (lvl !== null) {
                        const r = { lvl, prog: Math.random() * 1000, el: document.createElement('div') };
                        r.el.className = 'racer';
                        r.el.style.setProperty('--c', CAR_STATS[lvl].c);
                        layer.appendChild(r.el);
                        this.activeRacers.push(r);
                    }
                });
            }

            loop() {
                const W = 284, H = 384; 
                const lap = (W * 2) + (H * 2);
                this.activeRacers.forEach(r => {
                    r.prog += CAR_STATS[r.lvl].spd * this.turboMult;
                    let p = r.prog % lap;
                    let x, y, ang;
                    if (p < W) { x = p; y = 0; ang = 0; }
                    else if (p < W + H) { x = W; y = p - W; ang = 90; }
                    else if (p < (W * 2) + H) { x = W - (p - (W + H)); y = H; ang = 180; }
                    else { x = 0; y = H - (p - (W * 2 + H)); ang = 270; }
                    r.el.style.transform = `translate(${x + 6}px, ${y + 6}px) rotate(${ang}deg)`;
                });
                document.getElementById('balance').innerText = `$${Math.floor(this.coins)}`;
                requestAnimationFrame(() => this.loop());
            }

            renderGrid() {
                const pit = document.getElementById('pit-grid');
                pit.innerHTML = '';
                this.grid.forEach((lvl, i) => {
                    const slot = document.createElement('div');
                    slot.className = 'slot';
                    if (lvl !== null) slot.innerHTML = `<div class="racer" style="position:relative; --c:${CAR_STATS[lvl].c}"></div>`;
                    slot.onclick = () => this.merge(i);
                    pit.appendChild(slot);
                });
            }

            openSettings() { alert("Total Earned: $" + this.coins + "\nUse 'Reset Data' in console to wipe."); }
            openWheel() { alert("Wheel spinning logic added in next update!"); }
        }
        const game = new JDM_Turbo_Final_Fix();
    </script>
</body>
</html>
